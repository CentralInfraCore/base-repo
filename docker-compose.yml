version: '3.8'

services:
  # This service is ONLY for initializing and updating the python virtual environment cache
  setup:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      # Mount the project root to access requirements files
      - ./:/app
      # Mount the venv directory to be populated
      - ./p_venv:/app/p_venv:rw
    # The command to run to setup the environment
    command: >
      sh -c "
        pip-compile -o requirements.txt requirements.in &&
        pip install --no-cache-dir -r requirements.txt --target /app/p_venv
      "

  # This is the main service for running build, validation, and release tasks
  builder:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      # Mount the populated venv directory as a read-only cache
      - ./p_venv:/app/p_venv:ro
      # Mount the project root to access schemas and write to source
      - ./:/app:rw
    # This allows the container to reach the host machine (for Vault)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # Pass through environment variables for the release process
    environment:
      - VAULT_ADDR=${VAULT_ADDR}
      - VAULT_TOKEN=${VAULT_TOKEN}
    # Keep the container running in the background
    command: ["tail", "-f", "/dev/null"]
